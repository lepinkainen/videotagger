# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

dotenv: [".env"]

vars:
  EXECUTABLE: videotagger
  BUILDDIR: build
  VERSION:
    sh: |
      tag=$(git describe --tags 2>/dev/null || echo "dev")
      commit=$(git log -n 1 --format=%h)
      if [ "$tag" = "dev" ]; then
        echo "dev-$(date '+%Y-%m-%d_%H:%M:%S')"
      else
        echo "$tag-$commit"
      fi

tasks:
  # Core build task - depends on tests and linting
  build:
    desc: Build the project
    deps: [test, lint]
    cmds:
      - task: build-go

  # Linux-specific build
  build-linux:
    desc: Build for Linux
    deps: [test, lint]
    env:
      GOOS: linux
      GOARCH: amd64
    cmds:
      - task: build-go

  # CI build without tests/linting (run separately in CI)
  build-only:
    desc: Build binary without running tests or lint (for CI)
    cmds:
      - task: build-go

  build-ci:
    desc: Build for CI/CD (build with test-ci)
    deps: [test-ci]
    cmds:
      - task: build-go

  # Test tasks
  test:
    desc: Run tests
    cmds:
      - task: test-go

  test-ci:
    desc: Run tests with coverage for CI
    cmds:
      - task: test-go-ci

  # Linting tasks
  lint:
    desc: Lint code
    cmds:
      - task: lint-go

  # Clean build artifacts
  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.BUILDDIR}}

  # Go-specific tasks
  build-go:
    desc: Build Go binary
    cmds:
      - mkdir -p {{.BUILDDIR}}
      - go build -v -ldflags="-X main.Version={{.VERSION}}" -o {{.BUILDDIR}}/{{.EXECUTABLE}} main.go
    sources:
      - ./*.go
    generates:
      - "{{.BUILDDIR}}/{{.EXECUTABLE}}"

  build-go-cross:
    desc: Build Go binary for cross-compilation (uses GOOS/GOARCH from env)
    cmds:
      - mkdir -p {{.BUILDDIR}}
      - go build -v -ldflags="-X main.Version={{.VERSION}}" -o {{.BUILDDIR}}/{{.EXECUTABLE}} main.go
    env:
      CGO_ENABLED: "0"
    sources:
      - ./*.go
    generates:
      - "{{.BUILDDIR}}/{{.EXECUTABLE}}"

  test-go:
    desc: Run Go tests
    cmds:
      - go test $(go list ./... | grep -v llm-shared)
    sources:
      - ./**/*.go

  test-go-ci:
    desc: Run Go tests with coverage for CI
    cmds:
      - go test -tags=ci -coverprofile=coverage.out -cover -v $(go list ./... | grep -v llm-shared)
    sources:
      - ./**/*.go

  lint-go:
    desc: Lint Go code
    cmds:
      - find . -name "*.go" -not -path "./llm-shared/*" -exec goimports -w {} +
      - go vet $(go list ./... | grep -v llm-shared)
      - golangci-lint run ./...
    sources:
      - ./**/*.go
    silent: true

  # Project-specific tasks
  vet:
    desc: Run go vet
    cmds:
      - go vet $(go list ./... | grep -v llm-shared)
    sources:
      - ./**/*.go

  publish:
    desc: Publish binary to $HOME/bin
    deps: [build]
    cmds:
      - echo "Publishing to bin"
      - mkdir -p $HOME/bin/
      - cp {{.BUILDDIR}}/{{.EXECUTABLE}} $HOME/bin/

  upgrade-deps:
    desc: Upgrade all dependencies to their latest versions
    silent: true
    cmds:
      - go get -u ./...
      - go mod tidy
      - echo "âœ… Dependencies upgraded successfully"
    sources:
      - go.mod
      - go.sum
    generates:
      - go.mod
      - go.sum

  gen-test-files:
    desc: Generate test video files in temporary directory for testing
    cmds:
      - |
        TESTDIR="/tmp/videotagger-test-$(date +%s)"
        mkdir -p "$TESTDIR"
        echo "ğŸ“ Creating test files in: $TESTDIR"

        # Create test video files using FFmpeg (if available)
        if command -v ffmpeg >/dev/null 2>&1; then
          echo "ğŸ¬ Generating test videos with FFmpeg..."
          # Create a 5-second 720p test video
          ffmpeg -f lavfi -i testsrc=duration=5:size=1280x720:rate=30 -c:v libx264 -t 5 "$TESTDIR/test_720p.mp4" -y -loglevel quiet
          # Create a 3-second 1080p test video
          ffmpeg -f lavfi -i testsrc=duration=3:size=1920x1080:rate=30 -c:v libx264 -t 3 "$TESTDIR/test_1080p.mp4" -y -loglevel quiet
          # Create a duplicate of the 720p video
          cp "$TESTDIR/test_720p.mp4" "$TESTDIR/duplicate_720p.mp4"
          echo "âœ… Generated 3 test video files"
        else
          echo "âš ï¸  FFmpeg not found, creating placeholder files..."
          # Create placeholder files that look like videos but won't process
          touch "$TESTDIR/test_720p.mp4"
          touch "$TESTDIR/test_1080p.mp4"
          touch "$TESTDIR/duplicate_720p.mp4"
          echo "âš ï¸  Created placeholder files (install FFmpeg for real videos)"
        fi

        # Create some non-video files to test filtering
        echo "test content" > "$TESTDIR/readme.txt"
        echo "more content" > "$TESTDIR/document.pdf"

        echo ""
        echo "ğŸ§ª Test directory ready: $TESTDIR"
        echo "ğŸ“‹ Files created:"
        ls -la "$TESTDIR"
        echo ""
        echo "ğŸš€ Test commands:"
        echo "   ./build/videotagger tag $TESTDIR/*.mp4"
        echo "   ./build/videotagger duplicates $TESTDIR"
        echo "   ./build/videotagger verify $TESTDIR/*_[*].mp4"
        echo ""
        echo "ğŸ—‘ï¸  Cleanup when done: rm -rf $TESTDIR"
